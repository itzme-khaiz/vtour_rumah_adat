<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CRUD Gambar – Tur Virtual Baruga (Admin)</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <header>
        <h1>CRUD Gambar Tur Virtual Baruga</h1>
        <div class="muted">Kelola daftar scene (index, judul, file panorama, yaw/pitch/hfov). Simpan ke JSON atau ekspor file <code>tour.html</code> siap pakai.</div>
    </header>

    <main>
        <!-- LEFT: FORM -->
        <section class="card">
        <h3 class="section-title">Form Scene</h3>
        <div class="spacer"></div>
        <label>Index (angka, 0–53)</label>
        <input id="idx" type="number" min="0" max="999" placeholder="Contoh: 0" />

        <div class="spacer"></div>
        <label>Judul</label>
        <input id="title" type="text" placeholder="Contoh: Spot 0 / Serambi" />

        <div class="spacer"></div>
        <label>Nama file panorama (di folder <code>panos/</code>)</label>
        <input id="filename" type="text" placeholder="Contoh: 0.jpg" />

        <div class="spacer"></div>
        <div class="row">
            <div>
            <label>Yaw (°)</label>
            <input id="yaw" type="number" step="0.1" placeholder="0" />
            </div>
            <div>
            <label>Pitch (°)</label>
            <input id="pitch" type="number" step="0.1" placeholder="0" />
            </div>
        </div>

        <div class="spacer"></div>
        <div class="row">
            <div>
            <label>HFOV</label>
            <input id="hfov" type="number" step="1" placeholder="110" />
            </div>
            <div>
            <label>Hotspot Next (scene index)</label>
            <input id="next" type="number" step="1" placeholder="Mis. 1" />
            </div>
        </div>

        <div class="spacer"></div>
        <label>Hotspot Back (scene index)</label>
        <input id="back" type="number" step="1" placeholder="Mis. 0" />

        <div class="spacer"></div>
        <div class="preview" id="previewBox"><span class="muted">Pratinjau gambar (drag & drop file di sini atau klik bawah)</span></div>
        <div class="spacer"></div>
        <input id="file" type="file" accept="image/*" />
        <div class="muted">Catatan: File yang dipilih hanya untuk pratinjau cepat. Untuk publikasi, pastikan file sebenarnya berada di <code>panos/</code> dengan nama yang sama seperti di atas.</div>

        <div class="spacer"></div>
        <div class="controls">
            <button class="btn" onclick="saveScene()">Simpan / Update</button>
            <button class="btn secondary" onclick="resetForm()">Reset Form</button>
            <button class="btn danger" onclick="deleteByIndex()">Hapus (berdasar Index)</button>
        </div>
        </section>

        <!-- RIGHT: TABLE + EXPORT -->
        <section class="card">
        <div class="section-header">
            <h3 class="section-title">Daftar Scene</h3>
            <div class="actions">
            <button class="btn secondary" onclick="importJSON()">Import JSON</button>
            <button class="btn" onclick="exportJSON()">Export JSON</button>
            <button class="btn" onclick="exportTourHTML()">Export tour.html</button>
            </div>
        </div>

        <table>
            <thead>
            <tr>
                <th class="col-index">Index</th>
                <th>Judul</th>
                <th>File</th>
                <th>Yaw</th>
                <th>Pitch</th>
                <th>HFOV</th>
                <th>Next</th>
                <th>Back</th>
                <th class="right">Aksi</th>
            </tr>
            </thead>
            <tbody id="rows"></tbody>
        </table>

        <div class="muted info-note">Data tersimpan otomatis ke <em>localStorage</em> browser dengan key <code>barugaScenes</code>.</div>
        </section>
    </main>

    <script>
        const KEY = 'barugaScenes';
        let state = load();

        const els = {
        idx: document.getElementById('idx'),
        title: document.getElementById('title'),
        filename: document.getElementById('filename'),
        yaw: document.getElementById('yaw'),
        pitch: document.getElementById('pitch'),
        hfov: document.getElementById('hfov'),
        next: document.getElementById('next'),
        back: document.getElementById('back'),
        file: document.getElementById('file'),
        rows: document.getElementById('rows'),
        preview: document.getElementById('previewBox')
        };

        // --- Drag & drop preview ---
        els.preview.addEventListener('dragover', e => { e.preventDefault(); els.preview.style.borderColor = '#22d3ee'; });
        els.preview.addEventListener('dragleave', e => { els.preview.style.borderColor = '#2a3a58'; });
        els.preview.addEventListener('drop', e => {
        e.preventDefault(); els.preview.style.borderColor = '#2a3a58';
        if (e.dataTransfer.files && e.dataTransfer.files[0]) { els.file.files = e.dataTransfer.files; handleFilePreview(); }
        });
        els.file.addEventListener('change', handleFilePreview);

        function handleFilePreview(){
        const f = els.file.files?.[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        els.preview.innerHTML = `<img src="${url}" alt="preview">`;
        // opsi: otomatis isi nama file ke input filename
        if(!els.filename.value) els.filename.value = f.name;
        }

        function load(){
        try{ return JSON.parse(localStorage.getItem(KEY)) || [] }catch{ return [] }
        }
        function persist(){ localStorage.setItem(KEY, JSON.stringify(state)); }

        function render(){
        state.sort((a,b)=>a.index-b.index);
        els.rows.innerHTML = state.map(s=>`
            <tr>
            <td><strong>${s.index}</strong></td>
            <td>${escapeHtml(s.title||'')}</td>
            <td><code>${escapeHtml(s.filename||'')}</code></td>
            <td>${s.yaw??''}</td>
            <td>${s.pitch??''}</td>
            <td>${s.hfov??''}</td>
            <td>${s.next??''}</td>
            <td>${s.back??''}</td>
            <td class="right">
                <button class="btn secondary" onclick='edit(${s.index})'>Edit</button>
                <button class="btn danger" onclick='removeScene(${s.index})'>Hapus</button>
            </td>
            </tr>`).join('');
        }

        function saveScene(){
        const item = {
            index: num(els.idx.value),
            title: els.title.value.trim() || `Spot ${els.idx.value}`,
            filename: els.filename.value.trim(),
            yaw: optNum(els.yaw.value, 0),
            pitch: optNum(els.pitch.value, 0),
            hfov: optNum(els.hfov.value, 110),
            next: optNumEmpty(els.next.value),
            back: optNumEmpty(els.back.value)
        };
        if(Number.isNaN(item.index)) return alert('Index harus angka.');
        if(!item.filename) return alert('Nama file panorama wajib diisi.');

        const i = state.findIndex(s=>s.index===item.index);
        if(i>=0) state[i]=item; else state.push(item);
        persist();
        render();
        alert('Tersimpan.');
        }

        function edit(index){
        const s = state.find(x=>x.index===index); if(!s) return;
        els.idx.value = s.index;
        els.title.value = s.title||'';
        els.filename.value = s.filename||'';
        els.yaw.value = s.yaw??'';
        els.pitch.value = s.pitch??'';
        els.hfov.value = s.hfov??'';
        els.next.value = s.next??'';
        els.back.value = s.back??'';
        els.idx.scrollIntoView({behavior:'smooth',block:'center'});
        }

        function removeScene(index){
        if(!confirm('Hapus scene '+index+'?')) return;
        state = state.filter(s=>s.index!==index);
        persist(); render();
        }

        function deleteByIndex(){
        const v = Number(prompt('Masukkan index yang akan dihapus:'));
        if(Number.isNaN(v)) return;
        removeScene(v);
        }

        function resetForm(){
        els.idx.value = '';
        els.title.value = '';
        els.filename.value = '';
        els.yaw.value = '';
        els.pitch.value = '';
        els.hfov.value = '';
        els.next.value = '';
        els.back.value = '';
        els.file.value = '';
        els.preview.innerHTML = '<span class="muted">Pratinjau gambar (drag & drop file di sini atau klik bawah)</span>';
        }

        function exportJSON(){
        const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
        download(blob, 'baruga-scenes.json');
        }

        function importJSON(){
        const inp = document.createElement('input');
        inp.type='file'; inp.accept='application/json';
        inp.onchange = ()=>{
            const f = inp.files?.[0]; if(!f) return;
            const r = new FileReader();
            r.onload = ()=>{ try{
            const arr = JSON.parse(r.result);
            if(!Array.isArray(arr)) return alert('Format tidak valid (harus array).');
            state = arr.map(normalizeItem).filter(Boolean);
            persist(); render(); alert('Import sukses.');
            }catch(e){ alert('Gagal membaca JSON: '+e.message) } };
            r.readAsText(f);
        };
        inp.click();
        }

        function exportTourHTML(){
        if(state.length===0) return alert('Tidak ada scene.');
        const first = state.slice().sort((a,b)=>a.index-b.index)[0];
        const scenes = state.map(s=> toSceneBlock(s)).join(',\n      ');
        const buttons = state.slice().sort((a,b)=>a.index-b.index)
            .map(s=>`<button onclick="viewer.loadScene('s${s.index}')">${s.index}</button>`).join('\n    ');

        const html = `<!DOCTYPE HTML>
    <html>
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tur Virtual Baruga</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <link rel="stylesheet" href="css/baruga.css">
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
</head>
<body>
    <div id="panorama"></div>
    <div class="scenes">
        ${buttons}
    </div>

    <script>
        var viewer = pannellum.viewer('panorama', {
        "default": { "firstScene": "s${first.index}", "autoLoad": true, "showControls": true },
        "scenes": {
            ${scenes}
        }
        });
    </script>
    </body>
    </html>`;

        const blob = new Blob([html], {type:'text/html'});
        download(blob, 'tour.html');
        }

        function toSceneBlock(s){
        const hs = [];
        if(isNum(s.back)) hs.push(`{ "yaw": 180, "pitch": 0, "type": "scene", "text": "Back to ${s.back}", "sceneId": "s${s.back}" }`);
        if(isNum(s.next)) hs.push(`{ "yaw": 0, "pitch": 0, "type": "scene", "text": "Go to ${s.next}", "sceneId": "s${s.next}" }`);
        if(hs.length===0) hs.push(`{ "yaw": -90, "pitch": 0, "type": "info", "text": "#${s.index}" }`);
        return `"s${s.index}": { "title": ${JSON.stringify(s.title||`Spot ${s.index}`)}, "type": "equirectangular", "panorama": ${JSON.stringify('panos/'+s.filename)}, "yaw": ${numOr(s.yaw,0)}, "pitch": ${numOr(s.pitch,0)}, "hfov": ${numOr(s.hfov,110)}, "hotSpots": [ ${hs.join(', ')} ] }`;
        }

        function normalizeItem(o){
        if(typeof o!== 'object') return null;
        const idx = Number(o.index); if(Number.isNaN(idx)) return null;
        return {
            index: idx,
            title: String(o.title||'')||`Spot ${idx}`,
            filename: String(o.filename||'').trim(),
            yaw: isNum(o.yaw)?Number(o.yaw):0,
            pitch: isNum(o.pitch)?Number(o.pitch):0,
            hfov: isNum(o.hfov)?Number(o.hfov):110,
            next: isNum(o.next)?Number(o.next):undefined,
            back: isNum(o.back)?Number(o.back):undefined,
        }
        }

        function num(v){ return Number(v) }
        function optNum(v, def){ const n = Number(v); return Number.isNaN(n)?def:n }
        function numOr(v, def){ return (typeof v==='number' && !Number.isNaN(v))? v : def }
        function isNum(v){ return typeof v==='number' && !Number.isNaN(v) }
        function optNumEmpty(v){ const n = Number(v); return Number.isNaN(n)? undefined : n }

        function download(blob, filename){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = filename; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
        }

        function escapeHtml(s){ return String(s).replace(/[&<>"] /g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]||c)) }

        // init
        render();
    </script>
</body>
</html>
